local Players = game:GetService("Players")
local player = Players.LocalPlayer
local StarterGui = game:GetService("StarterGui")

-- Prevent double load
if getgenv().LoaderV2 == nil then
    getgenv().LoaderV2 = true
end
if not getgenv().LoaderV2 then return end

-- Load user list from external file
local success, userList = pcall(function()
    local code = game:HttpGet("https://raw.githubusercontent.com/dyumra/Whitelist/refs/heads/main/DYHUB-PREMIUM.lua")
    local func = loadstring(code)
    if func then
        return func()
    else
        error("Failed to load user table")
    end
end)

if not success or type(userList) ~= "table" then
    StarterGui:SetCore("SendNotification", {
        Title = "Error",
        Text = "Failed to load user data",
        Duration = 5,
    })
    return
end

local playerName = player and player.Name or ""
local playerKey = getgenv().DYHUBKEY or ""
local kickMessage = "‚ùå Invalid Key!\nüí≥ Please buy a Premium Key from (dsc.gg/dyhub)"

-- Check if player exists in whitelist
local playerData = userList[playerName]
if not playerData then
    StarterGui:SetCore("SendNotification", {
        Title = "Access Denied",
        Text = "The first user must reset HWID before proceeding",
        Duration = 5,
    })
    return
end

-- Check key validity
if playerKey ~= playerData.Key and playerKey ~= "DYHUB-NEED2ROBUX" then
    StarterGui:SetCore("SendNotification", {
        Title = "Invalid Key",
        Text = "Your key is invalid or missing. The script will not run",
        Duration = 5,
    })
    task.wait(5)
    player:Kick(kickMessage)
    return
end

-- Store extra user info for later use
getgenv().UserTag = playerData.Tag
getgenv().ExpireTime = playerData.Time

-- If everything is fine, load the main script
loadstring(game:HttpGet("https://raw.githubusercontent.com/dyumra/Premium/refs/heads/main/Premium.savekey"))()
